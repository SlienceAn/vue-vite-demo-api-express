# stages:
#   - test
#   - dockerLogin

# variables:
#   DOCKER_REGISTRY: docker.io
#   DOCKER_USERNAME: $DOCKERHUB_USERNAME 
#   DOCKER_PASSWORD: $DOCKERHUB_PASSWORD  

# before_script:
#   - echo "列出全部變數"
#   - printenv | sort

# test:
#   stage: test
#   only:
#     - master
#   script:
#     - echo "測試 dev build !!!"
#     - echo "測試環境變數 ---> $POSTGRES_DATABASE"
#     - echo "測試群組變數 ---> $PUSHER_SECRET"
#     - echo "測試群組變數 ---> $POSTGRES_URL_NO_SSL"
#     - echo "測試群組變數 ---> $POSTGRES_URL_NON_POOLING"
#     - echo "測試群組變數 ---> $POSTGRES_URL"
    
# docker-login:
#   stage: dockerLogin
#   only:
#     - master
#   script:
#     - echo "登入 Docker Hub"
#     - echo "$DOCKER_PASSWORD" | docker login $DOCKER_REGISTRY -u "$DOCKER_USERNAME" --password-stdin
#     - echo "推送鏡像到 Docker Hub"

image: node:latest

services: 
  - docker:dind
stages: 
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375

build:
  stage: build
  script: 
    - echo "Build Start !"
    - npm install -g pnpm
    - pnpm install
    - pnpm webpack
  artifacts:
    paths:
      - dist/
deploy:
  image: docker:latest
  stage: deploy
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - echo "Docker Hub 登入"
    - docker images
    - docker-compose build
    - echo "Docker Build !!!"   
    - docker images 
    - docker-compose push
    - echo "Docker Push !!!"
  only:
    - master 
