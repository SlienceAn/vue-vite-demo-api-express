include:
  - project: 'AIOT_demo/CICD-template'
    ref: main
    file: '.gitlab-ci.yml' 

services: 
  - docker:dind

stages: 
  - build
  - push
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  DIST_REPO_URL: git@gitlab.com:aiot_demo/vue-vite-demo-api-express-dist.git

cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - node_modules/  

build:
  image: node:latest
  stage: build
  script: 
    - echo "webpacké–‹å§‹æ‰“åŒ…"
    - npm install -g pnpm
    - pnpm install 
    - pnpm build
  artifacts:
    paths:
      - dist/
  only:
    - master

push:
  stage: push
  extends: setup_ssh
  needs:
    - setup_ssh
    - build
  dependencies:
    - setup_ssh
    - build
  script:  
    - echo "æª¢æŸ¥SSHæª”æ¡ˆ:"
    - ls -la .ssh/
    - ls -la
    - pwd
    - export GIT_SSH_COMMAND="ssh -i $PWD/.ssh/id_rsa -o UserKnownHostsFile=$PWD/.ssh/known_hosts"
    # gitæ¨é€
    - cd dist
    - rm -rf .git
    - git init
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME" 
    - git remote add origin $DIST_REPO_URL
    - git add -f .
    - git commit -m "$CI_COMMIT_MESSAGE"
    - git push -f origin master:main
    # æˆåŠŸå¾Œé¡¯ç¤ºè¨Šæ¯
    - echo "ğŸ‰ Git push éšæ®µå®Œæˆï¼æˆåŠŸæ¨è‡³Dist"
    - echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬ï¼š$CI_COMMIT_SHA"
    - echo "ğŸ‘¤ éƒ¨ç½²è€…ï¼š$GITLAB_USER_NAME"
    - echo "ğŸ•’ éƒ¨ç½²æ™‚é–“ï¼š$(date)"

deploy:
  image: docker:latest
  stage: deploy
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - echo "Docker Hub ç™»å…¥"
    - docker images
    - docker-compose build
    - docker images 
    - docker push beast964089/vue-vite-demo-api-express:latest
  only:
    - master 
