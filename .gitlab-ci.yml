# stages:
#   - test
#   - dockerLogin

# variables:
#   DOCKER_REGISTRY: docker.io
#   DOCKER_USERNAME: $DOCKERHUB_USERNAME 
#   DOCKER_PASSWORD: $DOCKERHUB_PASSWORD  

# before_script:
#   - echo "åˆ—å‡ºå…¨éƒ¨è®Šæ•¸"
#   - printenv | sort

# test:
#   stage: test
#   only:
#     - master
#   script:
#     - echo "æ¸¬è©¦ dev build !!!"
#     - echo "æ¸¬è©¦ç’°å¢ƒè®Šæ•¸ ---> $POSTGRES_DATABASE"
#     - echo "æ¸¬è©¦ç¾¤çµ„è®Šæ•¸ ---> $PUSHER_SECRET"
#     - echo "æ¸¬è©¦ç¾¤çµ„è®Šæ•¸ ---> $POSTGRES_URL_NO_SSL"
#     - echo "æ¸¬è©¦ç¾¤çµ„è®Šæ•¸ ---> $POSTGRES_URL_NON_POOLING"
#     - echo "æ¸¬è©¦ç¾¤çµ„è®Šæ•¸ ---> $POSTGRES_URL"
    
# docker-login:
#   stage: dockerLogin
#   only:
#     - master
#   script:
#     - echo "ç™»å…¥ Docker Hub"
#     - echo "$DOCKER_PASSWORD" | docker login $DOCKER_REGISTRY -u "$DOCKER_USERNAME" --password-stdin
#     - echo "æ¨é€é¡åƒåˆ° Docker Hub"

image: node:latest

services: 
  - docker:dind

stages: 
  - build
  - deploy

variables:
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
cache:
  key: $CI_COMMIT_REF_SLUG
  paths:
    - node_modules/

build:
  stage: build
  script: 
    - echo "Build Start !"
    - npm install -g pnpm
    - pnpm install --prod
    - pnpm build
  artifacts:
    paths:
      - dist/
  only:
    - master

push:
  stage: push
  script:  
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - ssh-keyscan gitlab.com >> ~/.ssh/known_hosts
    - chmod 644 ~/.ssh/known_hosts
    # gitæ¨é€
    - cd dist
    - rm -rf .git
    - git init
    - git config --global user.email "$GITLAB_USER_EMAIL"
    - git config --global user.name "$GITLAB_USER_NAME" 
    - git remote add origin $DIST_REPO_URL
    - git add -f .
    - git commit -m "$CI_COMMIT_MESSAGE"
    - git push -f origin master:main
    # æˆåŠŸå¾Œé¡¯ç¤ºè¨Šæ¯
    - echo "ğŸ‰ Push éšæ®µå®Œæˆï¼"
    - echo "ğŸ“¦ éƒ¨ç½²ç‰ˆæœ¬ï¼š$CI_COMMIT_SHA"
    - echo "ğŸ‘¤ éƒ¨ç½²è€…ï¼š$GITLAB_USER_NAME"
    - echo "ğŸ•’ éƒ¨ç½²æ™‚é–“ï¼š$(date)"


deploy:
  image: docker:latest
  stage: deploy
  script:
    - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
    - echo "Docker Hub ç™»å…¥"
    - docker images
    - docker-compose build
    - echo "Docker Build (æ‰“åŒ…)" 
    - echo "åˆ—å‡ºæ‰€æœ‰ Docker æ˜ åƒï¼š"
    - docker images 
    - docker push beast964089/vue-vite-demo-api-express:latest
    - echo "Docker Push (æ¨ä¸ŠHub)"
  only:
    - master 
